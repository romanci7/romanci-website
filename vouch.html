<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMANCI — Vouch</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --gold: #c9a24d;
    --gold-dark: #a8842c;
    --cream: #fff8ec;
    --bg: linear-gradient(135deg,#fffaf0,#f6efe0);
    --muted:#6b655a;
    --glass-bg: rgba(255,255,255,0.10);
    --glass-border: rgba(255,255,255,0.18);
    --card-shadow: 0 18px 50px rgba(0,0,0,0.06);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg);
    -webkit-font-smoothing:antialiased;
    color:#222;
  }

  header{ text-align:center; padding:40px 20px 6px; }
  header h1{ font-family:'Playfair Display', serif; font-size:36px; color:var(--gold); margin:0; letter-spacing:1px; }
  header p{ color:var(--muted); margin:8px 0 0; }

  .wrap{ max-width:1060px; margin:0 auto 80px; padding:0 20px; }
  .grid{ display:grid; grid-template-columns:1fr 380px; gap:28px; align-items:start; }
  @media (max-width:960px){ .grid{ grid-template-columns:1fr; } }

  /* Liquid glass card */
  .glass {
    background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.12));
    border-radius:16px;
    padding:22px;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(201,162,77,0.08);
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    transition: transform .35s cubic-bezier(.2,.9,.2,1), box-shadow .35s;
  }
  .glass:hover{ transform: translateY(-6px); box-shadow: 0 28px 80px rgba(0,0,0,0.08); }

  h2 { margin:0 0 10px; color:var(--gold-dark); font-family:'Playfair Display'; }
  label{ display:block; margin-top:12px; color:#544c41; font-size:0.9rem; }
  input[type="text"], textarea {
    width:100%; padding:12px 14px; margin-top:6px; border-radius:10px; border:1px solid rgba(0,0,0,0.06);
    background: rgba(255,255,255,0.92);
    font-size:1rem;
    resize:none;
  }
  input:focus, textarea:focus { outline:none; box-shadow:0 8px 30px rgba(201,162,77,0.12); border-color:var(--gold); }

  .row { display:flex; gap:12px; align-items:center; margin-top:14px; }
  .btn {
    background: linear-gradient(135deg,var(--gold),var(--gold-dark));
    color:#fff; border:none; padding:12px 18px; border-radius:12px; cursor:pointer; font-weight:600;
    box-shadow: 0 12px 30px rgba(201,162,77,0.16);
  }
  .btn[disabled]{ opacity:0.6; cursor:not-allowed; box-shadow:none; transform:none; }

  .muted { color:var(--muted); font-size:0.95rem; }

  /* Feed */
  .feed .title { color:var(--gold-dark); font-family:'Playfair Display'; margin-bottom:8px; }
  .vouches { display:grid; gap:12px; margin-top:6px; max-height:520px; overflow:auto; padding-right:6px; }
  .vouch {
    border-radius:12px; padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.98), #fff);
    border:1px solid rgba(201,162,77,0.06); box-shadow:0 10px 25px rgba(0,0,0,0.04);
  }
  .vouch .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .vouch .name { color:var(--gold-dark); font-weight:700; }
  .vouch .time { font-size:0.85rem; color:#7a746a; }

  /* small UI */
  .hint { font-size:0.9rem; color:#6e665c; margin-top:8px; }

  /* Modal */
  .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.46); opacity:0; pointer-events:none; transition:opacity .28s; z-index:999; }
  .modal.show{ opacity:1; pointer-events:auto; }
  .modal-card{
    background: linear-gradient(180deg,#fff,#fffaf8);
    border-radius:14px; padding:22px; width:360px; text-align:center;
    transform:translateY(12px) scale(.98); transition: transform .36s cubic-bezier(.2,.9,.2,1), opacity .28s; opacity:0;
  }
  .modal.show .modal-card{ transform:translateY(0) scale(1); opacity:1; }
  .r-icon {
    width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    margin:0 auto 10px; font-family:'Playfair Display'; font-size:30px;
    background: linear-gradient(135deg,var(--gold),var(--gold-dark)); color:white; box-shadow:0 10px 30px rgba(201,162,77,0.22);
  }
  .modal-card h3{ margin:6px 0 4px; color:var(--gold-dark); font-size:18px; }
  .modal-card p{ color:#5b544b; margin:8px 0 12px; }

  .icon-btn {
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06);
    background:transparent; text-decoration:none; color:#333; font-weight:700;
  }
  .icon-svg { width:18px; height:18px; fill:currentColor; }

  /* tiny responsive */
  @media (max-width:600px){
    .grid { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<header>
  <h1>ROMANCI VOUCH</h1>
  <p>One vouch every 12 hours. Enter the passcode to submit. Vouches appear publicly in real time.</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Left: Submit -->
    <div class="glass">
      <h2>Leave a Vouch</h2>

      <form id="form" autocomplete="off">
        <label for="code">Passcode</label>
        <input id="code" type="text" placeholder="Enter code to vouch (example: ROMANCI)" autocomplete="off" required>

        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Your name or handle" required>

        <label for="message">Vouch</label>
        <textarea id="message" rows="5" placeholder="Describe your experience with ROMANCI" required></textarea>

        <div class="row">
          <button class="btn" id="submitBtn" type="submit">Submit</button>
          <div style="flex:1">
            <div id="cooldownMsg" class="muted">You can submit once every 12 hours.</div>
          </div>
        </div>

        <div class="hint">Tip: passcode is required so only trusted people can post.</div>
      </form>
    </div>

    <!-- Right: Feed -->
    <aside class="glass feed">
      <div class="title">Community Vouches</div>
      <div id="vouches" class="vouches" aria-live="polite"></div>
    </aside>

  </div>
</div>

<!-- Thank you modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="r-icon" aria-hidden="true">R</div>
    <h3 id="modalTitle">Thank you from ROMANCI</h3>
    <p>Your vouch is live. Thank you for contributing.</p>
    <div style="margin-top:10px">
      <a class="icon-btn" href="index.html" id="homeBtn">
        <!-- Home SVG icon -->
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V11.5z"/></svg>
        Home
      </a>
    </div>
  </div>
</div>

<!-- Firebase & app logic -->
<script type="module">
/* ================== IMPORTANT ==================
  const firebaseConfig = {
  apiKey: "AIzaSyCT1_NEA_UIu_1dSTgy5awbGQI-7KCywVo",
  authDomain: "romanci-vouch.firebaseapp.com",
  projectId: "romanci-vouch",
  storageBucket: "romanci-vouch.firebasestorage.app",
  messagingSenderId: "154787033593",
  appId: "1:154787033593:web:24d3185cdedfdbaded8d28",
  measurementId: "G-W6SHFKE1EC"
};
============================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp,
  getDocs, where, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

/* PASTE YOUR FIREBASE CONFIG OBJECT HERE */
const firebaseConfig = {
  apiKey: "AIzaSyCT1_NEA_UIu_1dSTgy5awbGQI-7KCywVo",
  authDomain: "romanci-vouch.firebaseapp.com",
  projectId: "romanci-vouch",
  storageBucket: "romanci-vouch.firebasestorage.app",
  messagingSenderId: "154787033593",
  appId: "1:154787033593:web:24d3185cdedfdbaded8d28",
  measurementId: "G-W6SHFKE1EC"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- settings ---------- */
const PASSCODE = "ROMANCI"; // required code (case-insensitive)
const COOLDOWN_MS = 12 * 60 * 60 * 1000; // 12 hours
const CLIENT_KEY = "romanci_client_v3";
const LAST_KEY = "romanci_last_ts_v3";

/* ---------- client id ---------- */
let clientId = localStorage.getItem(CLIENT_KEY);
if(!clientId){
  clientId = 'c_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem(CLIENT_KEY, clientId);
}

/* ---------- DOM ---------- */
const form = document.getElementById('form');
const codeInput = document.getElementById('code');
const nameInput = document.getElementById('name');
const msgInput = document.getElementById('message');
const submitBtn = document.getElementById('submitBtn');
const cooldownMsg = document.getElementById('cooldownMsg');
const vouchesEl = document.getElementById('vouches');
const modal = document.getElementById('modal');

/* helper: humanize ms */
function msToHuman(ms){
  if(ms<=0) return '0s';
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  if(h>0) return `${h}h ${m}m`;
  if(m>0) return `${m}m`;
  return `${Math.floor(ms/1000)}s`;
}

/* cooldown UI from localStorage */
function getLocalRemaining(){
  const last = Number(localStorage.getItem(LAST_KEY) || 0);
  const rem = Math.max(0, COOLDOWN_MS - (Date.now() - last));
  return rem;
}
function updateCooldownUI(){
  const rem = getLocalRemaining();
  if(rem>0){
    cooldownMsg.textContent = `You may submit again in ${msToHuman(rem)}.`;
    submitBtn.disabled = true;
  } else {
    cooldownMsg.textContent = `You can submit once every 12 hours.`;
    submitBtn.disabled = false;
  }
}
updateCooldownUI();
setInterval(updateCooldownUI, 20000);

/* ---------- realtime feed (no admin approval required) ---------- */
(function listenAll(){
  const q = query(collection(db,'vouches'), orderBy('timestamp','desc'));
  onSnapshot(q, snap => {
    vouchesEl.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const card = document.createElement('div');
      card.className = 'vouch';
      const name = sanitize(d.name || 'Anonymous');
      const text = sanitize(d.message || d.text || '');
      const t = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate() : null;
      const timeStr = t ? new Date(t).toLocaleString() : '';
      card.innerHTML = `
        <div class="top">
          <div class="name">${name}</div>
          <div class="time">${timeStr}</div>
        </div>
        <div class="body">${text}</div>
      `;
      vouchesEl.appendChild(card);
    });
  }, err => {
    console.error('Realtime error', err);
    // optionally fallback to one-time fetch
  });
})();

/* ---------- submit logic ---------- */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  submitBtn.disabled = true;

  const code = (codeInput.value || '').trim();
  const name = (nameInput.value || '').trim();
  const message = (msgInput.value || '').trim();

  // basic validation
  if(!code || code.toUpperCase() !== PASSCODE.toUpperCase()){
    alert('Invalid passcode.');
    submitBtn.disabled = false;
    return;
  }
  if(!name || !message){
    alert('Please fill name and vouch.');
    submitBtn.disabled = false;
    return;
  }

  // local cooldown
  const localRem = getLocalRemaining();
  if(localRem > 0){
    alert(`Please wait ${msToHuman(localRem)} before submitting again.`);
    submitBtn.disabled = false;
    return;
  }

  // server-side cooldown check using clientId
  try {
    const cutoff = Timestamp.fromDate(new Date(Date.now() - COOLDOWN_MS));
    const q = query(collection(db,'vouches'), where('clientId','==', clientId), where('timestamp','>=', cutoff));
    const snap = await getDocs(q);
    if(!snap.empty){
      // compute remaining from newest doc
      let newest = 0;
      snap.forEach(d => {
        const t = d.data().timestamp;
        if(t && t.toDate) newest = Math.max(newest, t.toDate().getTime());
      });
      const rem = Math.max(0, COOLDOWN_MS - (Date.now() - newest));
      alert(`You already submitted recently. Please wait ${msToHuman(rem)} before submitting again.`);
      submitBtn.disabled = false;
      return;
    }
  } catch(err) {
    console.error('Cooldown check error', err);
    // allow unless you want to block on error
  }

  // all good — submit
  try {
    await addDoc(collection(db,'vouches'), {
      name,
      message,
      clientId,
      timestamp: serverTimestamp()
    });

    // set local cooldown
    localStorage.setItem(LAST_KEY, String(Date.now()));
    updateCooldownUI();

    // show modal
    showModal(true);

    // clear form
    form.reset();
  } catch(err){
    console.error('Submit failed', err);
    alert('Submit failed: ' + (err.message || err));
  } finally {
    submitBtn.disabled = false;
  }
});

/* ---------- modal helpers ---------- */
function showModal(autoHide=true){
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');
  if(autoHide){
    setTimeout(()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }, 3000);
  }
}

/* utility: sanitize to prevent HTML injection */
function sanitize(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

</script>
</body>
</html>
