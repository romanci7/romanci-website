<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ROMANCI ‚Äî Vouches</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#c9a24d;
    --gold-dark:#a8842c;
    --cream:#fff8ec;
    --bg:#fbf6ee;
    --muted:#6b655a;
    --card: rgba(255,255,255,0.97);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(135deg,#fffaf0,#f6efe0);
    color:#222;
    -webkit-font-smoothing:antialiased;
  }

  header{ text-align:center; padding:36px 20px 8px; }
  header h1{ font-family:'Playfair Display', serif; font-size:36px; color:var(--gold); margin:0; letter-spacing:2px; }
  header p{ color:var(--muted); margin:8px 0 0; }

  .wrap{ max-width:980px; margin:0 auto 80px; padding:0 20px; }
  .grid{ display:grid; grid-template-columns:1fr 380px; gap:28px; align-items:start; }
  @media (max-width:960px){ .grid{ grid-template-columns:1fr; } }

  .card{ background:var(--card); border-radius:16px; padding:22px; box-shadow:0 18px 50px rgba(0,0,0,0.06); border:1px solid rgba(201,162,77,0.10); }
  h2{ margin:0 0 10px; color:var(--gold-dark); font-family:'Playfair Display'; }

  label{ display:block; font-size:0.9rem; color:#4a463f; margin-top:12px; margin-bottom:6px; }
  input[type="text"], textarea {
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid #e6ddd0; background:white; font-size:1rem; resize:none;
  }
  input:focus, textarea:focus { outline:none; box-shadow:0 8px 24px rgba(201,162,77,0.12); border-color:var(--gold); }

  .submit-row{ display:flex; gap:12px; margin-top:16px; align-items:center; }
  .btn {
    background: linear-gradient(135deg,var(--gold),var(--gold-dark));
    color:#fff; border:none; padding:12px 20px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:0 12px 30px rgba(201,162,77,0.16);
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  .cooldown{ color:#8a7661; font-size:0.95rem; }

  .feed .title{ color:var(--gold-dark); font-family:'Playfair Display'; margin-bottom:8px; }
  .vouches{ display:grid; gap:12px; margin-top:6px; }
  .vouch{ background:linear-gradient(180deg, rgba(255,255,255,0.98), #fff); padding:12px; border-radius:12px; border:1px solid rgba(201,162,77,0.06); box-shadow:0 8px 25px rgba(0,0,0,0.04); }
  .vouch .name{ color:var(--gold-dark); font-weight:700; margin-bottom:6px; }
  .vouch .text{ color:#444; line-height:1.5; }

  /* popup modal */
  .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition:opacity .28s ease; z-index:999; }
  .modal.show{ opacity:1; pointer-events:auto; }
  .modal-card{ background: linear-gradient(180deg,#fff,#fffaf8); border-radius:14px; padding:22px; width:340px; max-width:92%; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,0.32); transform:translateY(18px) scale(.98); transition:transform .36s cubic-bezier(.2,.9,.2,1), opacity .28s; opacity:0; }
  .modal.show .modal-card{ transform:translateY(0) scale(1); opacity:1; }
  .rlogo{ width:72px; height:72px; margin:0 auto 8px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-family:'Playfair Display'; font-size:34px; background:linear-gradient(135deg,var(--gold),var(--gold-dark)); box-shadow:0 8px 30px rgba(201,162,77,0.25); }
  .modal-card h4{ margin:6px 0 4px; color:var(--gold-dark); font-size:20px; }
  .modal-card p{ color:#5b544b; margin:8px 0 12px; }
  .modal-actions{ display:flex; gap:10px; justify-content:center; margin-top:8px; }
  .link-btn{ padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); color:#333; text-decoration:none; font-weight:600; background:transparent; }

  .small{ font-size:0.9rem; color:#6e665c; margin-top:10px; display:block; }
</style>
</head>
<body>

<header>
  <h1>ROMANCI VOUCH</h1>
  <p>Share a short vouch ‚Äî visible after admin approval. (One vouch per device every 12 hours)</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: Submit -->
    <div class="card">
      <h2>Leave a Vouch</h2>
      <form id="vouchForm">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Your name or handle" required>

        <label for="message">Vouch</label>
        <textarea id="message" rows="5" placeholder="Why ROMANCI stood out..." required></textarea>

        <div class="submit-row">
          <button class="btn" id="submitBtn" type="submit">Submit Vouch</button>
          <div style="flex:1">
            <div id="cooldownMsg" class="cooldown">You can submit once every 12 hours.</div>
          </div>
        </div>

        <div class="small">Your vouch will be reviewed by admin before appearing.</div>
      </form>
    </div>

    <!-- RIGHT: Feed -->
    <aside class="card feed">
      <div class="title">Community Vouches</div>
      <div id="vouches" class="vouches">
        <!-- approved vouches will appear here -->
      </div>
    </aside>

  </div>
</div>

<!-- modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="rlogo" title="ROMANCI">R</div>
    <h4>Thank you from ROMANCI</h4>
    <p>Your vouch was received. We'll review it shortly.</p>
    <div class="modal-actions">
      <a class="link-btn" href="index.html">üè† Home</a>
      <a class="link-btn" href="#vouches" id="showVouchesBtn">‚≠ê Show Vouches</a>
    </div>
  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
  getDocs,
  Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

/* ===== REPLACE with your firebase config object from Project Settings ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCT1_NEA_UIu_1dSTgy5awbGQI-7KCywVo",
  authDomain: "romanci-vouch.firebaseapp.com",
  projectId: "romanci-vouch",
  storageBucket: "romanci-vouch.firebasestorage.app",
  messagingSenderId: "154787033593",
  appId: "1:154787033593:web:24d3185cdedfdbaded8d28",
  measurementId: "G-W6SHFKE1EC"
};
/* ======================================================================== */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- Cooldown settings ---------- */
const COOLDOWN_MS = 12 * 60 * 60 * 1000; // 12 hours
const LAST_KEY = 'romanci_last_vouch_ts_v1';

/* Elements */
const form = document.getElementById('vouchForm');
const nameInput = document.getElementById('name');
const msgInput = document.getElementById('message');
const submitBtn = document.getElementById('submitBtn');
const cooldownMsg = document.getElementById('cooldownMsg');
const vouchesEl = document.getElementById('vouches');
const modal = document.getElementById('modal');
const showVouchesBtn = document.getElementById('showVouchesBtn');

/* Helper: escape for safe DOM insertion */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/* ---------- Update UI with approved vouches only ---------- */
(function listenApproved(){
  try {
    const q = query(
      collection(db,'vouches'),
      where('approved','==', true),
      orderBy('timestamp','desc')
    );
    onSnapshot(q, snap => {
      vouchesEl.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const wrap = document.createElement('div');
        wrap.className = 'vouch';
        const name = escapeHtml(d.name || d.author || 'Anonymous');
        const text = escapeHtml(d.message || d.text || '');
        wrap.innerHTML = `<div class="name">${name}</div><div class="text">${text}</div>`;
        vouchesEl.appendChild(wrap);
      });
    }, err => {
      console.error('Realtime read failed:', err);
      // fallback: try to read once (non-realtime)
      fetchApprovedOnce();
    });
  } catch (e) {
    console.error('Realtime setup error', e);
    fetchApprovedOnce();
  }

  async function fetchApprovedOnce(){
    try {
      const q2 = query(collection(db,'vouches'), where('approved','==', true), orderBy('timestamp','desc'));
      const snap = await getDocs(q2);
      vouchesEl.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const wrap = document.createElement('div');
        wrap.className = 'vouch';
        const name = escapeHtml(d.name || d.author || 'Anonymous');
        const text = escapeHtml(d.message || d.text || '');
        wrap.innerHTML = `<div class="name">${name}</div><div class="text">${text}</div>`;
        vouchesEl.appendChild(wrap);
      });
    } catch(err) {
      console.error('Fetch once failed', err);
    }
  }
})();

/* ---------- Cooldown UI ---------- */
function getRemaining(){
  const last = Number(localStorage.getItem(LAST_KEY) || 0);
  const rem = Math.max(0, COOLDOWN_MS - (Date.now() - last));
  return rem;
}
function msToHuman(ms){
  if(ms<=0) return '0s';
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  if(h>0) return `${h}h ${m}m`;
  if(m>0) return `${m}m`;
  return `${Math.floor(ms/1000)}s`;
}
function updateCooldownUI(){
  const rem = getRemaining();
  if(rem>0){
    cooldownMsg.textContent = `You may submit again in ${msToHuman(rem)}.`;
    submitBtn.disabled = true;
  } else {
    cooldownMsg.textContent = `You can submit once every 12 hours.`;
    submitBtn.disabled = false;
  }
}
updateCooldownUI();
setInterval(updateCooldownUI, 30000);

/* ---------- Submit flow ---------- */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  submitBtn.disabled = true;

  const name = (nameInput.value || '').trim();
  const message = (msgInput.value || '').trim();

  if(!name || !message){
    alert('Please fill name and vouch.');
    submitBtn.disabled = false;
    return;
  }

  // Local cooldown check
  if(getRemaining() > 0){
    alert(`Please wait ${msToHuman(getRemaining())} before submitting again.`);
    submitBtn.disabled = false;
    return;
  }

  try {
    // Add to Firestore as pending
    await addDoc(collection(db,'vouches'), {
      name,
      message,
      approved: false,
      timestamp: serverTimestamp()
    });

    // Update local cooldown timestamp
    localStorage.setItem(LAST_KEY, String(Date.now()));
    updateCooldownUI();

    // show modal popup
    showModal(true);

    // reset form
    form.reset();
  } catch(err) {
    console.error('Submit failed', err);
    alert('Failed to submit vouch: ' + (err.message || err));
  } finally {
    submitBtn.disabled = false;
  }
});

/* ---------- Modal helpers ---------- */
function showModal(autoHide=true){
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');
  if(autoHide){
    setTimeout(()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }, 3000);
  }
}
showVouchesBtn.addEventListener('click', (ev)=>{
  ev.preventDefault();
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  document.querySelector('#vouches')?.scrollIntoView({behavior:'smooth'});
});

</script>
</body>
</html>
